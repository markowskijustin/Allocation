---
title: "Geocoding"
output: html_document
date: "2023-10-17"
---



# Library

```{r}

library(tidyverse)
library(usmap)
library(tidycensus)
library(tigris)
library(tidygeocoder)
library(gganimate)

```


# Read in data

```{r}
 
sites <- read_csv("/Users/markow/Dropbox/Git/Competition/data_processed/sites_geocoded.csv") %>% 
  select(`BHCMIS ID`:`Site ZIP Code`, Zip)

```


# Code

```{r}
tbcoded <- sites


coded <-  geo(street = tbcoded[c(1:10000),]$`Site Street Address`, 
             city = tbcoded[c(1:10000),]$`Site City`, 
             state = tbcoded[c(1:10000),]$`Site State`, 
             method = "census", 
             full_results = TRUE)
  
coded <- cbind(coded, geo(street = tbcoded[c(1:10000),]$`Site Street Address 3`, 
             city = tbcoded[c(1:10000),]$`Site City`, 
             state = tbcoded[c(1:10000),]$`Site State`, 
             method = "census", 
             full_results = TRUE))
  
coded <- cbind(coded,  geo(street = tbcoded[c(1:10000),]$`Site Street Address`, 
             city = tbcoded[c(1:10000),]$`Site Street Address 2`, 
             method = "census", 
             full_results = TRUE))



for (g in 1:17){
  print (g)
 coded2 <-  geo(street = tbcoded[c((1 + g*10000):((g+1)*10000)),]$`Site Street Address`, 
             city = tbcoded[c((1 + g*10000):((g+1)*10000)),]$`Site City`, 
             state = tbcoded[c((1 + g*10000):((g+1)*10000)),]$`Site State`, 
             method = "census", 
             full_results = TRUE)
  
coded2 <- cbind(coded2, geo(street = tbcoded[c((1 + g*10000):((g+1)*10000)),]$`Site Street Address 3`, 
             city = tbcoded[c((1 + g*10000):((g+1)*10000)),]$`Site City`, 
             state = tbcoded[c((1 + g*10000):((g+1)*10000)),]$`Site State`, 
             method = "census", 
             full_results = TRUE))
  
coded2 <- cbind(coded2,  geo(street = tbcoded[c((1 + g*10000):((g+1)*10000)),]$`Site Street Address`, 
             city = tbcoded[c((1 + g*10000):((g+1)*10000)),]$`Site Street Address 2`, 
             method = "census", 
             full_results = TRUE)) 
coded <- rbind(coded, coded2)
}



 coded2 <-  geo(street = tbcoded[c(180001:188381),]$`Site Street Address`, 
             city = tbcoded[c(180001:188381),]$`Site City`, 
             state = tbcoded[c(180001:188381),]$`Site State`, 
             method = "census", 
             full_results = TRUE)
  
coded2 <- cbind(coded2, geo(street = tbcoded[c(180001:188381),]$`Site Street Address 3`, 
             city = tbcoded[c(180001:188381),]$`Site City`, 
             state = tbcoded[c(180001:188381),]$`Site State`, 
             method = "census", 
             full_results = TRUE))
  
coded2 <- cbind(coded2,  geo(street = tbcoded[c(180001:188381),]$`Site Street Address`, 
             city = tbcoded[c(180001:188381),]$`Site Street Address 2`, 
             method = "census", 
             full_results = TRUE)) 
coded <- rbind(coded, coded2)
```


```{r}

sites.coded <- cbind(sites, coded[,c(4,5, 10, 16, 17, 22, 27, 28, 33)]) 

#write.csv(x = sites.coded, file = "/Users/jhm65/Dropbox/Git/Allocation/data_processed/sites_halfway_geocoded.csv", row.names = FALSE)
#
#sites.coded <- read.csv("/Users/markow/Dropbox/Git/Allocation/data_processed/sites_halfway_geocoded.csv", colClasses = "character")


```


## Next Cleaning Steps

Need to finish the geocoding
```{r}
tbcoded <- sites.coded %>% 
  filter(is.na(lat) & is.na(lat.1) & is.na(lat.2)) %>% 
  mutate(add = paste(Site.Street.Address, Site.Street.Address.2, sep = ", "))


coded3 <- geo(address = tbcoded$add, 
             method = "census", 
             full_results = TRUE)




tbcoded <- sites.coded %>% 
  filter(is.na(lat) & is.na(lat.1) & is.na(lat.2)) %>% 
  mutate(add = paste(Site.Street.Address, Site.City, Site.State, sep = ", "))


coded4.1 <- geo(address = tbcoded[c(1:15000),]$add,
             method = "census", 
             full_results = TRUE)
coded4.2 <- geo(address = tbcoded[c(15001:37249),]$add,
             method = "census", 
             full_results = TRUE)

coded4 <- rbind(coded4.1, coded4.2)






tbcoded <- sites.coded %>% 
  filter(is.na(lat) & is.na(lat.1) & is.na(lat.2)) %>% 
  mutate(add = paste(Site.Street.Address.3, Site.City, Site.State, sep = ", "))

coded5 <- geo(address = tbcoded$add, 
             method = "census", 
             full_results = TRUE)



tbcoded <- sites.coded %>% 
  filter(is.na(lat) & is.na(lat.1) & is.na(lat.2)) %>% 
  mutate(add = paste(Site.Street.Address, Site.City, Site.State, Zip, sep = ", "))


coded6.1 <- geo(address = tbcoded[c(1:15000),]$add,
             method = "census", 
             full_results = TRUE)
coded6.2 <- geo(address = tbcoded[c(15001:37249),]$add,
             method = "census", 
             full_results = TRUE)

coded6 <- rbind(coded6.1, coded6.2)





#tbcoded <- cbind(tbcoded, coded3 %>% select(lat, long, matched_address))


  coded3 %>% select(lat, long, matched_address) %>% filter(!is.na(lat))
  coded4 %>% select(lat, long, matched_address) %>% filter(!is.na(lat))
  coded5 %>% select(lat, long, matched_address) %>% filter(!is.na(lat))
  coded6 %>% select(lat, long, matched_address) %>% filter(!is.na(lat))
  

  
  sites.coded %>% 
  filter(is.na(lat) & is.na(lat.1) & is.na(lat.2)) %>% 
  select(BHCMIS.ID:Zip) %>% 
  cbind(
  data.frame(coded3 %>% select(lat, long, matched_address), 
             coded4 %>% select(lat, long, matched_address), 
             coded5 %>% select(lat, long, matched_address), 
             coded6 %>% select(lat, long, matched_address)) %>% 
    mutate(lat = ifelse(!is.na(lat), lat, 
                        ifelse(is.na(lat) & !is.na(lat.1), lat.1, 
                               ifelse(is.na(lat) & is.na(lat.1), lat.2, 
                                      ifelse(is.na(lat) & is.na(lat.1) & is.na(lat.2), lat.3, NA)))),
           long = ifelse(!is.na(long), long, 
                        ifelse(is.na(long) & !is.na(long.1), long.1, 
                               ifelse(is.na(long) & is.na(long.1), long.2, 
                                      ifelse(is.na(long) & is.na(long.1) & is.na(long.2), long.3, NA))))) %>% 
    select(lat, long)) %>% 
    filter(is.na(lat))
```

## Merge Sets, make some more progress on coding

```{r}
  
sites.coded.almost <- rbind(sites.coded %>% 
  filter(!is.na(lat) | !is.na(lat.1) | !is.na(lat.2)) %>% 
   mutate(lat = ifelse(!is.na(lat), lat, 
                        ifelse(is.na(lat) & !is.na(lat.1), lat.1, 
                               ifelse(is.na(lat) & is.na(lat.1), lat.2, NA))),
           long = ifelse(!is.na(long), long, 
                        ifelse(is.na(long) & !is.na(long.1), long.1, 
                               ifelse(is.na(long) & is.na(long.1), long.2, NA)))) %>% 
  select(BHCMIS.ID:Zip, lat, long), 
  sites.coded %>% 
  filter(is.na(lat) & is.na(lat.1) & is.na(lat.2)) %>% 
  select(BHCMIS.ID:Zip) %>% 
  cbind(
  data.frame(coded3 %>% select(lat, long, matched_address), 
             coded4 %>% select(lat, long, matched_address), 
             coded5 %>% select(lat, long, matched_address), 
             coded6 %>% select(lat, long, matched_address)) %>% 
    mutate(lat = ifelse(!is.na(lat), lat, 
                        ifelse(is.na(lat) & !is.na(lat.1), lat.1, 
                               ifelse(is.na(lat) & is.na(lat.1) & !is.na(lat.2), lat.2, 
                                      ifelse(is.na(lat) & is.na(lat.1) & is.na(lat.2), lat.3, NA)))),
           long = ifelse(!is.na(long), long, 
                        ifelse(is.na(long) & !is.na(long.1), long.1, 
                               ifelse(is.na(long) & is.na(long.1) & !is.na(long.2), long.2, 
                                      ifelse(is.na(long) & is.na(long.1) & is.na(long.2), long.3, NA))))) %>% 
    select(lat, long)))


table(sites.coded.almost$Year, is.na(sites.coded.almost$lat))




tbcoded <- sites.coded.almost %>% 
  filter(is.na(lat)) %>% 
  mutate(add = paste(Site.Street.Address.3, Site.City, Site.State, Zip, sep = ", "))


coded7.1 <- geo(address = tbcoded[c(1:15000),]$add,
             method = "census", 
             full_results = TRUE)
coded7.2 <- geo(address = tbcoded[c(15001:27851),]$add,
             method = "census", 
             full_results = TRUE)

coded7 <- rbind(coded7.1, coded7.2)


coded7 %>% select(lat, long) %>% filter(!is.na(lat))


sites.coded.almost <- sites.coded.almost %>% 
  filter(!is.na(lat)) %>% 
  rbind(cbind(tbcoded %>% select(BHCMIS.ID:Zip), coded7 %>% select(lat, long) ))

table(sites.coded.almost$Year, is.na(sites.coded.almost$lat))


sites.coded.almost %>% 
  filter(is.na(lat))

```

## Final Coding and Cleaning - this takes a bit for some reason (~15 minutes)

```{r}

temp <- sites.coded.almost %>% 
  filter(is.na(lat)) %>% 
  select(BHCMIS.ID:Zip) #%>% filter(Site.City == "New Haven")

temp.coded <- geo(street = temp$Site.Street.Address, city = temp$Site.City, state = temp$Site.State, postalcode = temp$Zip, 
             method = "census", 
             full_results = TRUE)

sites.coded.almost.final <- sites.coded.almost %>% 
  filter(!is.na(lat)) %>% 
  rbind(cbind(temp %>% select(BHCMIS.ID:Zip), temp.coded %>% select(lat, long) ))

sites.coded.almost.final %>% 
  filter(is.na(lat))

```


## Do the rest by hand

```{r}


sites.coded.almost.final %>% 
  filter(is.na(lat))



ids <- unique(sites.coded.almost.final[is.na(sites.coded.almost.final$lat),]$BHCMIS.ID)


i <- 11

sites.coded.almost.final[sites.coded.almost.final$BHCMIS.ID == ids[i] ,] %>% 
  arrange(Site.Street.Address, Site.Street.Address.3)


## Set the function to do the replacement
sites.hand <- sites.coded.almost.final



geocoded.by.hand <- rbind(
  c("010070", "223 Portsea St", 41.297009, -72.933175), 
  c("010120", "256 Pleasant Street", 42.37918608231927, -72.51987353695388), 
  c("010120", "754 Alden Street", 42.1088790580001,	-72.543469919), 
  c("010120", "49-61 St. James Avenue", 42.1109923240001,	-72.573894579), 
  c("010130	", "404 Chestnut Street", 42.99110061868193, -71.46072106988214), 
  
  c("010170	", "100 Morrissey Boulevard", 42.314135433,	-71.046835546), 
  
  c("010170", "26-32 DEVINE WAY", 42.32863424664541, -71.05515641272427),
  c("010220", "330 Washington St STE 510", 41.54341840463725, -72.08685524806683),
  c("010220", "330 Washington St", 41.54341840463725, -72.08685524806683)
  
  )

geocoded.by.hand <- data.frame(geocoded.by.hand) %>% 
  rename(BHCMIS.ID = X1, add = X2, lat = X3, long = X4)



sites.hand <- rbind(sites.hand %>% 
    filter(!is.na(lat)),sites.hand %>% 
    filter(is.na(lat)) %>% 
    left_join(geocoded.by.hand, by = c("BHCMIS.ID", "Site.Street.Address" = "add")) %>% 
    left_join(geocoded.by.hand, by = c("BHCMIS.ID", "Site.Street.Address.2" = "add")) %>% 
    left_join(geocoded.by.hand, by = c("BHCMIS.ID", "Site.Street.Address.3" = "add")) %>% 
     mutate(lat = ifelse(!is.na(lat.x), lat.x, 
                        ifelse(is.na(lat.x) & !is.na(lat.y), lat.y, 
                               ifelse(is.na(lat.x) & is.na(lat.y) & !is.na(lat.x.x), lat.x.x, 
                                      ifelse(is.na(lat.x) & is.na(lat.y) & is.na(lat.x.x), lat.y.y, NA)))),
         long = ifelse(!is.na(long.x), long.x, 
                        ifelse(is.na(long.x) & !is.na(long.y), long.y, 
                               ifelse(is.na(long.x) & is.na(long.y) & !is.na(long.x.x), long.x.x, 
                                      ifelse(is.na(long.x) & is.na(long.y) & is.na(long.x.x), long.y.y, NA))))) %>% 
    select(BHCMIS.ID:Zip, lat, long)
)


nrow(sites.hand %>% filter(is.na(lat))) / nrow(sites.hand )
```



# Map - missing 1998 data
```{r}

eq_transformed <- usmap_transform(data = sites.coded  %>% mutate(lon = as.numeric(ifelse(is.na(long), long.1, 
                                                                                  ifelse(is.na(long) & is.na(long.1), long.2, long))), 
                                                                 lat = as.numeric(ifelse(is.na(lat), lat.1, 
                                                                                  ifelse(is.na(lat) & is.na(lat.1), lat.2, lat)))) %>% filter(!is.na(lat))) %>% 
  mutate(year = as.numeric(Year)) %>% 
  arrange(BHCMIS.ID, Site.Name, Year) %>% 
  filter(Year >= 1999) %>% 
  filter(Site.State %in% c("CT","RI","MA","NH","VT","ME"))
  #filter(Site.State %in% c("IL","IN","WI","MN","IA","MO","OH","MI"))


grafico <- plot_usmap(include = c("CT","RI","MA","NH","VT","ME")) +
  geom_point(data = eq_transformed, aes(x = x, y = y, col = Site.State), size = 0.5) +
  labs(title = "FQHC Care Delivery Location Growth",
       subtitle = "1999 - 2021") +
  theme(legend.position = "right")
```


```{r}

p <- grafico +
  transition_time(year) +
  labs(title = "FQHC Growth by Year: {frame_time}")

p <- animate(p, nframes = length(1999:2021), fps = 4)

anim_save("/Users/jhm65/Dropbox/Git/Allocation/visuals/growth.gif", p)

p
```














